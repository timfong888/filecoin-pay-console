type UserToken @entity(immutable: false) {
  id: Bytes! # account address,token address
  funds: BigInt!
  lockupCurrent: BigInt!
  lockupRate: BigInt!
  lockupLastSettledUntilEpoch: BigInt!
  lockupLastSettledUntilTimestamp: BigInt!
  payout: BigInt!
  fundsCollected: BigInt!
  account: Account!
  token: Token!
}

type Token @entity(immutable: false) {
  id: Bytes! # address
  name: String!
  symbol: String!
  decimals: BigInt!
  volume: BigInt!
  totalDeposits: BigInt!
  totalWithdrawals: BigInt!
  totalSettledAmount: BigInt!
  totalUsers: BigInt!
  userFunds: BigInt! # same as sum of all UserToken.funds
  operatorCommission: BigInt!
  userTokens: [UserToken!]! @derivedFrom(field: "token")
}

type Account @entity(immutable: false) {
  id: Bytes! # address
  address: Bytes!
  totalRails: BigInt!
  totalTokens: BigInt!
  totalApprovals: BigInt!

  payerRails: [Rail!]! @derivedFrom(field: "payer")
  payeeRails: [Rail!]! @derivedFrom(field: "payee")
  operatorApprovals: [OperatorApproval!]! @derivedFrom(field: "client")
  userTokens: [UserToken!]! @derivedFrom(field: "account")
}

type OperatorApproval @entity(immutable: false) {
  id: Bytes! # client address,operator address,token address
  isApproved: Boolean!
  maxLockupPeriod: BigInt!
  lockupAllowance: BigInt!
  rateAllowance: BigInt!
  lockupUsage: BigInt!
  rateUsage: BigInt!

  client: Account!
  operator: Operator!
  token: Token!
}

type OperatorToken @entity(immutable: false) {
  id: Bytes! # operator address,token address
  commissionEarned: BigInt!
  volume: BigInt!
  lockupAllowance: BigInt!
  rateAllowance: BigInt!
  lockupUsage: BigInt!
  rateUsage: BigInt!
  settledAmount: BigInt!

  operator: Operator!
  token: Token!
}

type Operator @entity(immutable: false) {
  id: Bytes! # address
  address: Bytes!
  totalRails: BigInt!
  totalTokens: BigInt!
  totalApprovals: BigInt!

  operatorTokens: [OperatorToken!]! @derivedFrom(field: "operator")
  rails: [Rail!]! @derivedFrom(field: "operator")
  operatorApprovals: [OperatorApproval!]! @derivedFrom(field: "operator")
}

enum RailState {
  ZERORATE
  ACTIVE
  TERMINATED
  FINALIZED
}

type Rail @entity(immutable: false) {
  id: Bytes! # railId
  railId: BigInt!
  paymentRate: BigInt!
  lockupFixed: BigInt!
  lockupPeriod: BigInt!
  settledUpto: BigInt!
  state: RailState!
  endEpoch: BigInt!
  arbiter: Bytes!
  commissionRateBps: BigInt!
  serviceFeeRecipient: Bytes!

  totalSettledAmount: BigInt!
  totalNetPayeeAmount: BigInt!
  totalCommission: BigInt!
  totalSettlements: BigInt!
  totalRateChanges: BigInt!

  createdAt: BigInt!

  payer: Account!
  payee: Account!
  operator: Operator!
  token: Token!

  settlements: [Settlement!]! @derivedFrom(field: "rail")
  rateChangeQueue: [RateChangeQueue!]! @derivedFrom(field: "rail")
}

type RateChangeQueue @entity(immutable: false) {
  id: Bytes! # railId,startEpoch
  startEpoch: BigInt!
  untilEpoch: BigInt!
  rate: BigInt!
  rail: Rail!
}

type Settlement @entity(immutable: true) {
  id: Bytes! # railId,settledUpto
  rail: Rail!
  totalSettledAmount: BigInt!
  totalNetPayeeAmount: BigInt!
  filBurned: BigInt!
  operatorCommission: BigInt!
  settledUpto: BigInt!
}

# Metrics

type PaymentsMetric @entity(immutable: false) {
  id: Bytes! # payments_network_stats
  totalRails: BigInt!
  totalOperators: BigInt!
  totalTokens: BigInt!
  totalAccounts: BigInt!
  totalFilBurned: BigInt!
  totalZeroRateRails: BigInt!
  totalActiveRails: BigInt!
  totalTerminatedRails: BigInt!
  totalFinalizedRails: BigInt!

  # Unique payers and payees
  uniquePayers: BigInt!
  uniquePayees: BigInt!
}

# Time-based metrics for analytics and graphs

type DailyMetric @entity(immutable: false) {
  id: Bytes! # timestamp (start of day in seconds)
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format for easier querying
  # Volume metrics
  filBurned: BigInt!

  # Rail metrics
  railsCreated: BigInt!
  totalRailSettlements: BigInt!
  railsTerminated: BigInt!
  railsFinalized: BigInt!
  activeRailsCount: BigInt!

  # Activity counts (no daily unique tracking to avoid overcount confusion when summing)
  newAccounts: BigInt! # First-time-ever accounts this day
  newOperators: BigInt! # First-time-ever operators this day
}

type WeeklyMetric @entity(immutable: false) {
  id: Bytes! # timestamp (start of week in seconds)
  timestamp: BigInt!
  weekStart: BigInt! # Sunday 00:00:00 UTC
  weekEnd: BigInt! # Saturday 23:59:59 UTC
  week: BigInt! # week number
  # Volume metrics
  filBurned: BigInt!

  # Rail metrics
  railsCreated: BigInt!
  totalRailSettlements: BigInt!
  railsTerminated: BigInt!
  railsFinalized: BigInt!
  activeRailsCount: BigInt!

  # User metrics - Per-week unique (via helper entities)
  uniqueActivePayers: BigInt! # Distinct wallets that created rails THIS week
  uniqueActivePayees: BigInt! # Distinct wallets that received rails THIS week
  # Legacy first-time-ever counts
  newPayers: BigInt! # First-time-ever payers
  newPayees: BigInt! # First-time-ever payees
  uniqueOperators: BigInt!
  uniqueAccounts: BigInt!
}

# Helper entities for tracking per-week unique users
type WeeklyActivePayer @entity(immutable: true) {
  id: ID! # "${weekStart}-${payerAddress}"
  weekStart: BigInt!
  payer: Bytes!
}

type WeeklyActivePayee @entity(immutable: true) {
  id: ID! # "${weekStart}-${payeeAddress}"
  weekStart: BigInt!
  payee: Bytes!
}

type DailyTokenMetric @entity(immutable: false) {
  id: Bytes! # token address + timestamp
  token: Token!
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format
  # Token-specific volume
  volume: BigInt!
  deposit: BigInt!
  withdrawal: BigInt!
  settledAmount: BigInt!
  commissionPaid: BigInt!

  # Token utilization
  activeRailsCount: BigInt!
  uniqueHolders: BigInt!
  totalLocked: BigInt!
}

type WeeklyTokenMetric @entity(immutable: false) {
  id: Bytes! # token address + week timestamp
  token: Token!
  timestamp: BigInt! # Start of week (Sunday 00:00 UTC)
  week: BigInt! # Week number
  # Token-specific volume
  volume: BigInt!
  deposit: BigInt!
  withdrawal: BigInt!
  settledAmount: BigInt! # Delta for this week
  commissionPaid: BigInt!

  # Token utilization
  activeRailsCount: BigInt!
  uniqueHolders: BigInt!
}

type DailyOperatorMetric @entity(immutable: false) {
  id: Bytes! # operator address + timestamp
  operator: Operator!
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format
  # Rail management
  railsCreated: BigInt!
  settlementsProcessed: BigInt!

  # Client metrics
  uniqueClients: BigInt!
  totalApprovals: BigInt!
}
